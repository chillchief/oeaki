<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>おえかき30ページ（サムネ切替・PNG一括・MP4誘導）</title>
<style>
  :root { color-scheme: light dark; }
  body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP"; background:#f6f7f9; }
  header { background:#1f2937; color:#fff; padding:10px 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  header .title { font-weight:600; margin-right:8px; }
  button, .pagebtn, .seg button, a.btn {
    padding:6px 10px; border-radius:8px; border:1px solid #64748b40; background:#fff; cursor:pointer; color:#111; text-decoration:none;
  }
  button.primary, .seg button.primary, a.btn.primary { background:#3b82f6; color:#fff; border-color:#3b82f6; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .seg { display:inline-flex; gap:6px; margin-left:4px; }
  main { display:grid; grid-template-columns: 1fr; gap:10px; padding:10px; }
  .canvas-wrap { display:flex; justify-content:center; }
  canvas#canvas { background:#fff; border:1px solid #e5e7eb; border-radius:8px; touch-action:none; }
  /* サムネ付きページ一覧（横スクロール） */
  .pages { display:flex; gap:8px; padding:8px 10px 10px; overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; background:#f1f5f9; border-bottom:1px solid #e5e7eb; }
  .pagebtn { background:transparent; border:none; padding:0; display:inline-grid; gap:4px; justify-items:center; }
  .thumb { width:96px; height:72px; border:1px solid #e5e7eb; border-radius:6px; background:#fff; display:block; }
  .pnum { font-size:12px; color:#334155; }
  .pagebtn.active .thumb { outline:2px solid #3b82f6; outline-offset:0; }
  /* 進捗バー */
  #bar { height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; width:320px; }
  #fill { height:100%; width:0%; background:#3b82f6; }
  #status { min-height:1.2em; font-size:13px; color:#374151; text-align:center; }
  #err { color:#b91c1c; font-size:12px; white-space:pre-wrap; text-align:center; }
  .spacer { flex:1; }
  .field { color:#e5e7eb; font-size:13px; }
  .field input { width:6em; padding:4px 6px; border-radius:6px; border:1px solid #64748b40; }
  .hidden { display:none !important; }
</style>
<!-- ZIP作成用ライブラリ（PNG一括のみ利用） -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
<header>
  <div class="title">おえかき 30ページ</div>

  <div class="row">
    <button id="penBtn" class="primary">ペン</button>
    <button id="eraserBtn">消しゴム</button>
    <button id="undoBtn">戻る</button>
    <button id="clearBtn">全消去</button>
    <button id="saveBtn">このページをPNG保存</button>
  </div>

  <div class="row">
    <span class="field">遅延(ms)：<input id="delayMs" type="number" min="10" step="10" value="100"></span>
    <button id="playBtn">▶︎ プレビュー</button>
    <!-- GIF作成ボタン削除済み / PNG一括（描画のみ）削除済み -->
    <button id="pngAllBtn" class="primary">PNG一括（全ページ）</button>
    <button id="toggleThumbsBtn">サムネ非表示</button>
    <a class="btn" href="images2mp4.html">画像→MP4ページへ</a>
  </div>

  <div class="spacer"></div>

  <div class="row" style="margin-left:auto">
    <button id="prevBtn">← 前</button>
    <div id="pageLabel">ページ 1 / 30</div>
    <button id="nextBtn">次 →</button>
  </div>
</header>

<div class="pages" id="pages"></div>

<main>
  <div class="canvas-wrap">
    <canvas id="canvas" width="640" height="480"></canvas>
  </div>
  <div class="row" style="justify-content:center; gap:12px;">
    <div id="bar"><div id="fill"></div></div>
    <div id="pct" style="width:60px; text-align:right;">0%</div>
  </div>
  <div id="status"></div>
  <div id="err"></div>
</main>

<script>
/* ========= 定数・状態 ========= */
const CANVAS_W = 640, CANVAS_H = 480;
const PAGE_COUNT = 30;
const TH_W = 96, TH_H = 72;

const PEN_SIZES = { small: 2,  medium: 4,  large: 8  };
const ERASER_SIZES = { small: 12, medium: 18, large: 26 };
let penSizeKey = 'medium';
let eraserSizeKey = 'medium';

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const pagesBar = document.getElementById('pages');
const pageLabel = document.getElementById('pageLabel');
const statusEl = document.getElementById('status');
const errEl = document.getElementById('err');
const fill = document.getElementById('fill');
const pct = document.getElementById('pct');
const delayInput = document.getElementById('delayMs');

let drawing=false, erasing=false, last=null;
let currentPage = 0;
const undoStack = [];
const UNDO_LIMIT = 50;

// 各ページの内容とサムネCanvas
const pages = Array.from({length: PAGE_COUNT}, () => ({ data: null, dirty: false, thumbEl: null }));

// プレビュー管理
let isPreview = false;
let previewTimer = null;
let previewFrames = [];
let previewIndex = 0;
let previewBackup = { pageIndex: 0, image: null };

/* ========= 初期化 ========= */
initCanvas();
buildPageThumbnails();
loadPage(0);
bindUI();
updatePageUI();
updateThumb(0, true);

function initCanvas(){
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function buildPageThumbnails(){
  for(let i=0;i<PAGE_COUNT;i++){
    const btn = document.createElement('button');
    btn.className = 'pagebtn' + (i===0 ? ' active' : '');
    const th = document.createElement('canvas');
    th.className = 'thumb';
    th.width = TH_W; th.height = TH_H;
    const num = document.createElement('div');
    num.className = 'pnum';
    num.textContent = (i+1);
    btn.append(th, num);
    btn.addEventListener('click', ()=> switchPage(i));
    pagesBar.appendChild(btn);
    pages[i].thumbEl = th;
    const tctx = th.getContext('2d');
    tctx.fillStyle = '#fff'; tctx.fillRect(0,0,TH_W,TH_H);
  }
}

function bindUI(){
  document.getElementById('penBtn').onclick    = ()=>{ erasing=false; setActive('penBtn'); };
  document.getElementById('eraserBtn').onclick = ()=>{ erasing=true;  setActive('eraserBtn'); };
  document.getElementById('undoBtn').onclick   = ()=>{ if(!isPreview){ undo(); updateThumb(currentPage, true); } };
  document.getElementById('clearBtn').onclick  = ()=>{ if(!isPreview){ pushSnapshot(); clearCanvas(); pages[currentPage].dirty=true; updateThumb(currentPage, true); } };
  document.getElementById('saveBtn').onclick   = ()=>{ if(!isPreview) saveCurrentPNG(); };
  document.getElementById('prevBtn').onclick   = ()=>{ if(!isPreview) switchPage(Math.max(0, currentPage-1)); };
  document.getElementById('nextBtn').onclick   = ()=>{ if(!isPreview) switchPage(Math.min(PAGE_COUNT-1, currentPage+1)); };

  // PNG一括（全ページ）
  document.getElementById('pngAllBtn').onclick   = ()=> exportAllPNGs({ includeEmpty:true });

  // サムネ表示/非表示切替
  document.getElementById('toggleThumbsBtn').onclick = ()=>{
    const hidden = pagesBar.classList.toggle('hidden');
    document.getElementById('toggleThumbsBtn').textContent = hidden ? 'サムネ表示' : 'サムネ非表示';
  };

  // プレビュー
  const playBtn = document.getElementById('playBtn');
  playBtn.onclick = ()=> isPreview ? stopPreview() : startPreview();

  // 描画
  canvas.addEventListener('pointerdown', (e)=>{
    if(isPreview) return;
    e.preventDefault();
    canvas.setPointerCapture(e.pointerId);
    drawing = true;
    last = getPos(e);
    pushSnapshot();
  });
  canvas.addEventListener('pointermove', (e)=>{
    if(!drawing || isPreview) return;
    const p = getPos(e);
    ctx.strokeStyle = erasing ? '#fff' : '#000';
    ctx.lineWidth = erasing ? ERASER_SIZES[eraserSizeKey] : PEN_SIZES[penSizeKey];
    ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke();
    last = p;
    pages[currentPage].dirty = true;
  });
  ['pointerup','poin]()
