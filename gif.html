<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>高速GIFメーカー（小さめ固定・進捗表示）</title>
<style>
  :root { color-scheme: light dark; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP"; margin: 0; padding: 16px; }
  h1 { font-size: 18px; margin: 0 0 12px; }
  .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  button { padding: 8px 12px; cursor: pointer; border-radius: 8px; border: 1px solid #9995; }
  button.primary { background: #3b82f6; color: #fff; border-color: #3b82f6; }
  #bar { height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; width: 320px; }
  #fill { height: 100%; width: 0%; background: #3b82f6; }
  #status { min-height: 1.4em; opacity: .9; }
  .hint { font-size: 12px; opacity: .7; }
</style>
<!-- GIFエンコーダ（CDN） -->
<script src="https://unpkg.com/gif.js.optimized/dist/gif.js"></script>
</head>
<body>
  <h1>高速GIFメーカー（320px固定・遅延100ms）</h1>
  <div class="row">
    <input id="files" type="file" accept="image/*" multiple>
    <button id="make" class="primary" disabled>GIFを作成</button>
    <span class="hint">※長辺320pxに自動縮小。処理は端末内で実行されます。</span>
  </div>
  <div class="row" style="margin-top:10px;">
    <div id="bar"><div id="fill"></div></div>
    <div id="pct" style="width:60px;text-align:right;">0%</div>
  </div>
  <div id="status" style="margin-top:8px;"></div>
  <a id="dl" style="display:none" download="animation.gif"></a>

<script>
const input = document.getElementById('files');
const makeBtn = document.getElementById('make');
const statusEl = document.getElementById('status');
const dlLink = document.getElementById('dl');
const fill = document.getElementById('fill');
const pct = document.getElementById('pct');

const DELAY_MS = 100;       // 各フレームの待ち時間（固定）
const TARGET_EDGE = 320;    // 出力GIFの長辺（固定）
const MAX_FILES = 20;       // 選択上限（任意）

let items = [];             // {url, img}

input.addEventListener('change', async (e) => {
  resetUI();
  const files = Array.from(e.target.files).filter(f => f.type.startsWith('image/')).slice(0, MAX_FILES);
  if (!files.length) { status('画像を選択してください'); return; }
  status('読み込み中…');
  items = [];
  for (const f of files) {
    const url = URL.createObjectURL(f);
    const img = await loadImage(url);
    items.push({ url, img });
  }
  status(`読み込み完了：${items.length}枚`);
  makeBtn.disabled = false;
});

makeBtn.addEventListener('click', async () => {
  if (!items.length) return;
  lock(true);
  try {
    status('エンコード準備中…');
    // ベースサイズ（1枚目の縦横比を保持しつつ長辺=TARGET_EDGEへ）
    const w0 = items[0].img.naturalWidth, h0 = items[0].img.naturalHeight;
    const s = Math.min(1, TARGET_EDGE / Math.max(w0, h0));
    const baseW = Math.max(1, Math.round(w0 * s));
    const baseH = Math.max(1, Math.round(h0 * s));

    // Canvas準備
    const cvs = document.createElement('canvas');
    const ctx = cvs.getContext('2d');
    cvs.width = baseW; cvs.height = baseH;

    // GIFエンコーダ設定：高速寄り
    const cores = Math.min(Math.max((navigator.hardwareConcurrency || 2), 2), 8);
    const gif = new GIF({
      workers: cores,
      quality: 20,                // 1(高画質/遅)〜20(速)。20=最速寄り
      dither: false,              // ディザ無効（さらに速い）
      workerScript: 'https://unpkg.com/gif.js.optimized/dist/gif.worker.js',
      width: baseW,
      height: baseH
    });

    // 進捗表示
    progress(0);
    gif.on('progress', p => progress(p));  // p: 0〜1
    gif.on('finished', (blob) => {
      const url = URL.createObjectURL(blob);
      dlLink.href = url;
      dlLink.style.display = '';
      dlLink.click(); // 自動ダウンロード
      setTimeout(() => URL.revokeObjectURL(url), 10000);
      progress(1);
      status('完了しました。ダウンロードをご確認ください。');
      lock(false);
    });

    // フレームを追加
    for (let i = 0; i < items.length; i++) {
      // 背景白で初期化（透過が不要なら推奨）
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, baseW, baseH);

      const {img} = items[i];
      // 画像を収まるようフィット（黒帯なし）
      const scale = Math.min(baseW / img.naturalWidth, baseH / img.naturalHeight);
      const w = Math.round(img.naturalWidth * scale);
      const h = Math.round(img.naturalHeight * scale);
      const x = Math.floor((baseW - w) / 2);
      const y = Math.floor((baseH - h) / 2);
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, x, y, w, h);

      gif.addFrame(cvs, { copy: true, delay: DELAY_MS });
      status(`フレーム追加中… ${i+1}/${items.length}`);
      await tick(); // UI更新のため小休止
    }

    status('エンコード中…');
    gif.render(); // 進捗は gif.on('progress') で更新されます
  } catch (err) {
    console.error(err);
    status('エラーが発生しました。画像サイズや枚数を減らして再度お試しください。');
    lock(false);
  }
});

function loadImage(url){
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = url;
  });
}
function status(t){ statusEl.textContent = t; }
function tick(){ return new Promise(r => setTimeout(r, 0)); }
function resetUI(){ progress(0); status(''); makeBtn.disabled = true; }
function progress(p){
  const pctVal = Math.max(0, Math.min(1, p));
  fill.style.width = (pctVal * 100).toFixed(0) + '%';
  pct.textContent = (pctVal * 100).toFixed(0) + '%';
}
function lock(isBusy){
  makeBtn.disabled = isBusy || !items.length;
  input.disabled = isBusy;
}
</script>
</body>
</html>
